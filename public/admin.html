<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MongoDB Admin Dashboard - EchoTune AI</title>
    <style>
        :root {
            --primary-color: #1db954;
            --secondary-color: #191414;
            --background-color: #121212;
            --surface-color: #282828;
            --text-color: #ffffff;
            --text-muted: #b3b3b3;
            --border-color: #404040;
            --error-color: #e22134;
            --warning-color: #ff9500;
            --success-color: #1db954;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-muted);
            font-size: 1.1em;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--surface-color);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .card h2 {
            color: var(--primary-color);
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .card h3 {
            color: var(--text-color);
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .health-score {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
        }

        .health-score.excellent {
            background: linear-gradient(135deg, var(--success-color), #22c55e);
            color: white;
        }

        .health-score.good {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }

        .health-score.fair {
            background: linear-gradient(135deg, var(--warning-color), #f59e0b);
            color: white;
        }

        .health-score.poor {
            background: linear-gradient(135deg, var(--error-color), #dc2626);
            color: white;
        }

        .performance-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .performance-badge.low {
            background-color: var(--success-color);
            color: var(--secondary-color);
        }

        .performance-badge.medium {
            background-color: var(--warning-color);
            color: var(--secondary-color);
        }

        .performance-badge.high {
            background-color: var(--error-color);
            color: white;
        }

        .cache-indicator {
            display: inline-block;
            padding: 2px 6px;
            background-color: rgba(29, 185, 84, 0.2);
            color: var(--primary-color);
            border-radius: 4px;
            font-size: 0.7em;
            margin-left: 8px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: var(--text-muted);
        }

        .metric-value {
            font-weight: bold;
            color: var(--text-color);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy {
            background-color: var(--success-color);
        }

        .status-warning {
            background-color: var(--warning-color);
        }

        .status-error {
            background-color: var(--error-color);
        }

        .recommendations {
            margin-top: 30px;
        }

        .recommendation {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .recommendation.critical {
            border-left: 4px solid var(--error-color);
        }

        .recommendation.important {
            border-left: 4px solid var(--warning-color);
        }

        .recommendation.suggestion {
            border-left: 4px solid var(--success-color);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .recommendation-type {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .collections-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .collections-table th,
        .collections-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .collections-table th {
            background-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: bold;
        }

        .collections-table tr:hover {
            background-color: rgba(29, 185, 84, 0.1);
        }

        .loading {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--text-muted);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background-color: rgba(226, 33, 52, 0.1);
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .btn {
            background-color: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .btn:hover {
            background-color: #1ed760;
        }

        .btn-secondary {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .export-section {
            margin-top: 20px;
            padding: 15px;
            background-color: rgba(29, 185, 84, 0.1);
            border-radius: 8px;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            cursor: pointer;
            border-bottom: none;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: var(--secondary-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 0 0 8px 8px;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè• MongoDB Admin Dashboard</h1>
            <p>Comprehensive database insights and administration tools for EchoTune AI</p>
        </div>

        <div id="connection-status" class="card">
            <h2>Connection Status</h2>
            <div id="status-content" class="loading">Loading connection status...</div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="showTab('overview')">Overview</div>
            <div class="tab" onclick="showTab('collections')">Collections</div>
            <div class="tab" onclick="showTab('performance')">Performance</div>
            <div class="tab" onclick="showTab('recommendations')">Recommendations</div>
            <div class="tab" onclick="showTab('export')">Export Tools</div>
        </div>

        <div id="overview" class="tab-content active">
            <div class="dashboard-grid">
                <div class="card">
                    <h2>üìä Database Overview</h2>
                    <div id="db-overview" class="loading">Loading database overview...</div>
                </div>

                <div class="card">
                    <h2>üóÉÔ∏è Collections Summary</h2>
                    <div id="collections-summary" class="loading">Loading collections...</div>
                </div>

                <div class="card">
                    <h2>üìà Performance Metrics</h2>
                    <div id="performance-metrics" class="loading">Loading performance data...</div>
                </div>

                <div class="card">
                    <h2>‚ö° Index Health</h2>
                    <div id="index-health" class="loading">Loading index analysis...</div>
                </div>

                <div class="card">
                    <h2>üéØ System Health Score</h2>
                    <div id="system-health" class="loading">Calculating system health...</div>
                </div>

                <div class="card">
                    <h2>üìä Data Quality Assessment</h2>
                    <div id="data-quality" class="loading">Analyzing data quality...</div>
                </div>
            </div>
        </div>

        <div id="collections" class="tab-content">
            <div class="card">
                <h2>üìã Collection Details</h2>
                <div id="collections-detail" class="loading">Loading detailed collection information...</div>
            </div>
        </div>

        <div id="performance" class="tab-content">
            <div class="card">
                <h2>üöÄ Performance Analysis</h2>
                <div id="performance-analysis" class="loading">Loading performance analysis...</div>
            </div>
        </div>

        <div id="recommendations" class="tab-content">
            <div class="card">
                <h2>üí° System Recommendations</h2>
                <div id="recommendations-content" class="loading">Loading recommendations...</div>
            </div>
        </div>

        <div id="export" class="tab-content">
            <div class="card">
                <h2>üì§ Data Export Tools</h2>
                <div class="export-section">
                    <h3>‚ö†Ô∏è Safe Export Guidelines</h3>
                    <ul style="color: var(--text-muted); margin: 10px 0; padding-left: 20px;">
                        <li>All exports are read-only and safe</li>
                        <li>Sensitive data is automatically sanitized</li>
                        <li>Maximum 10,000 documents per export</li>
                        <li>Export format: JSON or CSV</li>
                    </ul>
                </div>
                <div id="export-tools" class="loading">Loading export tools...</div>
            </div>
        </div>
    </div>

    <script>
        let dashboardData = null;
        let collectionsData = null;

        // Tab functionality
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load content if needed
            if (tabName === 'collections' && !collectionsData) {
                loadCollectionDetails();
            }
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Check connection status first
                const healthResponse = await fetch('/api/admin/health');
                const healthData = await healthResponse.json();
                
                const statusDiv = document.getElementById('status-content');
                if (healthData.success && healthData.mongodb.connected) {
                    statusDiv.innerHTML = `
                        <div class="metric">
                            <span class="metric-label">
                                <span class="status-indicator status-healthy"></span>MongoDB Status
                            </span>
                            <span class="metric-value">Connected</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Database</span>
                            <span class="metric-value">${healthData.mongodb.database || 'N/A'}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Response Time</span>
                            <span class="metric-value">${healthData.mongodb.responseTime || 'N/A'}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Admin Tools Version</span>
                            <span class="metric-value">${healthData.adminTools.version || '1.0.0'}</span>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="error">
                            <span class="status-indicator status-error"></span>
                            MongoDB is not connected. Admin tools are running with limited functionality.
                            <br><br>
                            <strong>Current Status:</strong> ${healthData.mongodb?.message || 'Database unavailable'}
                            <br>
                            <strong>Fallback Mode:</strong> SQLite database is active for basic functionality.
                            <br><br>
                            <strong>Note:</strong> All admin dashboard features require MongoDB connection.
                        </div>
                    `;
                }

                // Always attempt to load dashboard (will show graceful fallback)
                const response = await fetch('/api/admin/dashboard');
                const data = await response.json();
                
                if (data.success && data.dashboard) {
                    dashboardData = data.dashboard;
                    renderDashboard(dashboardData);
                    
                    // Show cache indicator if data is cached
                    if (data.dashboard.cached) {
                        const header = document.querySelector('.header p');
                        header.innerHTML += `<span class="cache-indicator">Cached ${data.dashboard.cacheAge}s ago</span>`;
                    }
                } else {
                    // Show fallback dashboard with helpful information
                    const fallbackData = data.dashboard || {
                        overview: { database: 'N/A', totalCollections: 0, totalDocuments: 0, totalDataSize: 0, uptime: 0 },
                        collections: [],
                        indexHealth: { healthy: 0, problematic: 0, unused: 0, recommendations: ['MongoDB connection required'] },
                        performance: { operations: { query: 0, insert: 0 }, memory: { resident: 0 } }
                    };
                    renderDashboard(fallbackData, true);
                    
                    if (data.error) {
                        showError(`Admin Dashboard: ${data.error}. Some features may not be available.`);
                    }
                }
            } catch (error) {
                console.error('Dashboard load error:', error);
                showError('Failed to load dashboard: ' + error.message);
                
                // Show completely offline state
                renderOfflineDashboard();
            }
        }

        // Render dashboard data
        function renderDashboard(data, isOffline = false) {
            const offlinePrefix = isOffline ? '[OFFLINE] ' : '';
            
            // Database overview
            const overviewDiv = document.getElementById('db-overview');
            overviewDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Database</span>
                    <span class="metric-value">${offlinePrefix}${data.overview.database}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Collections</span>
                    <span class="metric-value">${data.overview.totalCollections.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Total Documents</span>
                    <span class="metric-value">${data.overview.totalDocuments.toLocaleString()}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Data Size</span>
                    <span class="metric-value">${formatBytes(data.overview.totalDataSize)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Uptime</span>
                    <span class="metric-value">${formatUptime(data.overview.uptime)}</span>
                </div>
                ${isOffline ? '<div style="color: var(--warning-color); font-size: 0.9em; margin-top: 10px;">‚ö†Ô∏è Data shown from last successful connection</div>' : ''}
            `;

            // Collections summary
            const collectionsSummaryDiv = document.getElementById('collections-summary');
            const topCollections = data.collections
                .filter(c => !c.hasErrors)
                .sort((a, b) => (b.count || 0) - (a.count || 0))
                .slice(0, 5);
            
            if (topCollections.length > 0) {
                collectionsSummaryDiv.innerHTML = `
                    <div style="margin-bottom: 15px;">
                        <strong>${offlinePrefix}Total: ${data.overview.totalCollections} collections</strong>
                    </div>
                    ${topCollections.map(col => `
                        <div class="metric">
                            <span class="metric-label">${col.name}</span>
                            <span class="metric-value">${(col.count || 0).toLocaleString()} docs</span>
                        </div>
                    `).join('')}
                `;
            } else {
                collectionsSummaryDiv.innerHTML = `
                    <div style="color: var(--text-muted);">
                        ${isOffline ? 'No collection data available in offline mode' : 'No collections found'}
                    </div>
                `;
            }

            // Performance metrics
            const performanceDiv = document.getElementById('performance-metrics');
            performanceDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Active Connections</span>
                    <span class="metric-value">${data.overview.connections?.current || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Operations/sec</span>
                    <span class="metric-value">${formatNumber(
                        ((data.performance.operations?.query || 0) + (data.performance.operations?.insert || 0)) / Math.max(data.overview.uptime, 1)
                    )}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Memory Usage</span>
                    <span class="metric-value">${data.performance.memory?.resident || 0} MB</span>
                </div>
                ${isOffline ? '<div style="color: var(--warning-color); font-size: 0.9em; margin-top: 10px;">‚ö†Ô∏è Performance data requires active connection</div>' : ''}
            `;

            // Index health with enhanced performance indicators
            const indexDiv = document.getElementById('index-health');
            const totalIndexes = (data.indexHealth.healthy || 0) + (data.indexHealth.problematic || 0) + (data.indexHealth.unused || 0);
            indexDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">
                        <span class="status-indicator status-healthy"></span>Healthy Indexes
                    </span>
                    <span class="metric-value">${data.indexHealth.healthy || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="status-indicator status-warning"></span>Unused Indexes
                    </span>
                    <span class="metric-value">${data.indexHealth.unused || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">
                        <span class="status-indicator status-error"></span>Issues
                    </span>
                    <span class="metric-value">${data.indexHealth.problematic || 0}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">Performance Impact</span>
                    <span class="metric-value">
                        <span class="performance-badge ${data.indexHealth.performanceImpact || 'low'}">
                            ${(data.indexHealth.performanceImpact || 'low').toUpperCase()}
                        </span>
                    </span>
                </div>
                <div class="metric">
                    <span class="metric-label">Recommendations</span>
                    <span class="metric-value">${data.indexHealth.recommendations?.length || 0}</span>
                </div>
                ${isOffline ? '<div style="color: var(--warning-color); font-size: 0.9em; margin-top: 10px;">‚ö†Ô∏è Index analysis requires MongoDB connection</div>' : ''}
            `;

            // System Health Score
            if (data.systemHealth) {
                const healthDiv = document.getElementById('system-health');
                healthDiv.innerHTML = `
                    <div class="health-score ${data.systemHealth.status}">
                        <div>
                            <div style="font-size: 1.2em;">Overall Health</div>
                            <div style="font-size: 0.9em; opacity: 0.8;">${data.systemHealth.concerns?.length || 0} concerns identified</div>
                        </div>
                        <div style="font-size: 2em;">${data.systemHealth.score}/100</div>
                    </div>
                    ${data.systemHealth.concerns?.length > 0 ? 
                        '<div style="margin-top: 10px;"><strong>Concerns:</strong><ul style="margin: 5px 0; padding-left: 20px;">' +
                        data.systemHealth.concerns.map(c => `<li>${c}</li>`).join('') + 
                        '</ul></div>' : 
                        '<div style="color: var(--success-color); margin-top: 10px;">‚úÖ System running optimally</div>'
                    }
                `;
            }

            // Data Quality Assessment
            if (data.dataQuality) {
                const qualityDiv = document.getElementById('data-quality');
                qualityDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">Quality Score</span>
                        <span class="metric-value">${data.dataQuality.score}/100 (Grade ${data.dataQuality.grade})</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Status</span>
                        <span class="metric-value">
                            <span class="performance-badge ${data.dataQuality.status === 'good' ? 'low' : data.dataQuality.status === 'fair' ? 'medium' : 'high'}">
                                ${data.dataQuality.status.replace('_', ' ').toUpperCase()}
                            </span>
                        </span>
                    </div>
                    ${data.dataQuality.issues?.length > 0 ?
                        '<div style="margin-top: 10px;"><strong>Issues:</strong><ul style="margin: 5px 0; padding-left: 20px;">' +
                        data.dataQuality.issues.map(i => `<li>${i}</li>`).join('') +
                        '</ul></div>' :
                        '<div style="color: var(--success-color); margin-top: 10px;">‚úÖ Data quality is excellent</div>'
                    }
                `;
            }
            
            // Show warnings if any
            if (data.warnings && data.warnings.length > 0) {
                const warningsDiv = document.createElement('div');
                warningsDiv.className = 'error';
                warningsDiv.innerHTML = `
                    <strong>Warnings:</strong><br>
                    ${data.warnings.map(w => `‚Ä¢ ${w}`).join('<br>')}
                `;
                document.querySelector('.container').insertBefore(warningsDiv, document.querySelector('.tabs'));
            }
        }

        // Render complete offline dashboard
        function renderOfflineDashboard() {
            const offlineData = {
                overview: {
                    database: 'Offline',
                    totalCollections: 0,
                    totalDocuments: 0,
                    totalDataSize: 0,
                    uptime: 0,
                    connections: { current: 0 }
                },
                collections: [],
                indexHealth: {
                    healthy: 0,
                    problematic: 0,
                    unused: 0,
                    recommendations: ['MongoDB connection required for admin features']
                },
                performance: {
                    operations: { query: 0, insert: 0 },
                    memory: { resident: 0 }
                }
            };
            
            renderDashboard(offlineData, true);
        }

        // Load collection details
        async function loadCollectionDetails() {
            try {
                const response = await fetch('/api/admin/collections');
                const data = await response.json();
                
                if (data.success) {
                    collectionsData = data;
                    renderCollectionDetails(data);
                } else {
                    showError('Failed to load collections: ' + data.error);
                }
            } catch (error) {
                console.error('Collections load error:', error);
                showError('Failed to load collections: ' + error.message);
            }
        }

        // Render collection details
        function renderCollectionDetails(data) {
            const detailDiv = document.getElementById('collections-detail');
            
            const tableHTML = `
                <table class="collections-table">
                    <thead>
                        <tr>
                            <th>Collection Name</th>
                            <th>Documents</th>
                            <th>Data Size</th>
                            <th>Avg Doc Size</th>
                            <th>Indexes</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.collections.map(col => `
                            <tr>
                                <td><strong>${col.name}</strong></td>
                                <td>${col.count ? col.count.toLocaleString() : '0'}</td>
                                <td>${formatBytes(col.size || 0)}</td>
                                <td>${formatBytes(col.avgSize || 0)}</td>
                                <td>${col.indexCount || 0}</td>
                                <td>
                                    ${col.hasErrors 
                                        ? '<span class="status-indicator status-error"></span>Error' 
                                        : '<span class="status-indicator status-healthy"></span>Healthy'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            detailDiv.innerHTML = tableHTML;
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function formatUptime(seconds) {
            if (!seconds) return 'N/A';
            const days = Math.floor(seconds / 86400);
            const hours = Math.floor((seconds % 86400) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${days}d ${hours}h ${minutes}m`;
        }

        function formatNumber(num) {
            return parseFloat(num.toFixed(2));
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            
            // Insert after header
            const header = document.querySelector('.header');
            header.parentNode.insertBefore(errorDiv, header.nextSibling);
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            if (document.querySelector('.tab.active').textContent === 'Overview') {
                loadDashboard();
            }
        }, 30000);
    </script>
</body>
</html>